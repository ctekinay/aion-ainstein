<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AInstein - Routing Settings</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --bg-page: #1e1e2e;
            --bg-card: #282838;
            --bg-input: #313244;
            --bg-status: #2d2d3d;
            --text-primary: #cdd6f4;
            --text-secondary: #a6adc8;
            --text-muted: #6c7086;
            --border: #45475a;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-page: #f1f5f9;
                --bg-card: #ffffff;
                --bg-input: #e2e8f0;
                --bg-status: #f1f5f9;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                --text-muted: #64748b;
                --border: #cbd5e1;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .back-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        /* Mode selector cards */
        .mode-section {
            margin-bottom: 28px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .section-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .mode-group {
            display: flex;
            gap: 10px;
        }

        .mode-card {
            flex: 1;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
        }

        .mode-card:hover {
            border-color: var(--text-muted);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.08);
        }

        .mode-card .mode-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .mode-card .mode-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Toggle groups */
        .toggle-group {
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            background: var(--bg-card);
            transition: opacity 0.25s;
        }

        .toggle-group.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .toggle-group-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 10px 16px 6px;
            background: var(--bg-status);
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            transition: opacity 0.2s;
        }

        .toggle-row:first-child {
            border-top: none;
        }

        .toggle-row.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .toggle-row .toggle-info {
            flex: 1;
            margin-right: 14px;
        }

        .toggle-row .toggle-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .toggle-row .toggle-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .toggle-row.sub-toggle {
            padding-left: 36px;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--border);
            border-radius: 22px;
            transition: background 0.2s;
        }

        .toggle-switch .slider::before {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch input:checked + .slider {
            background: var(--primary);
        }

        .toggle-switch input:checked + .slider::before {
            transform: translateX(18px);
        }

        .toggle-switch input:disabled + .slider {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Inline select */
        .inline-select {
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .inline-select:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Threshold slider */
        .threshold-row {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            transition: opacity 0.2s;
        }

        .threshold-row.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .threshold-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .threshold-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .threshold-value {
            color: var(--primary);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
        }

        /* Info box */
        .info-box {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 14px 16px;
            background: var(--bg-status);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-box .info-icon {
            color: var(--primary);
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .info-box .info-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn-save {
            flex: 1;
            padding: 14px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-save:hover {
            background: var(--primary-dark);
        }

        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 10px;
            border: 1px solid var(--primary);
            font-size: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            z-index: 999;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Routing Settings</h1>
            <a class="back-link" href="/">&#8592; Back to chat</a>
        </div>

        <!-- Mode selector -->
        <div class="mode-section">
            <div class="section-label">Routing Mode</div>
            <div class="section-hint">Choose how queries are classified and routed</div>
            <div class="mode-group">
                <div class="mode-card selected" id="mode-card-strict" onclick="selectMode(true)">
                    <div class="mode-title">Strict Mode</div>
                    <div class="mode-desc">Keyword-triggered deterministic routing. Fast, predictable, no LLM classification.</div>
                </div>
                <div class="mode-card" id="mode-card-llm" onclick="selectMode(false)">
                    <div class="mode-title">LLM Mode</div>
                    <div class="mode-desc">Intent router classifies queries first, then Elysia Tree handles reasoning.</div>
                </div>
            </div>
        </div>

        <!-- Strict-mode sub-options -->
        <div class="toggle-group" id="strict-options">
            <div class="toggle-group-header">Strict Mode Options</div>
            <div class="toggle-row">
                <div class="toggle-info">
                    <div class="toggle-name">Catalog short-circuit</div>
                    <div class="toggle-desc">List/count queries bypass Elysia Tree with deterministic results</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rp-catalog" checked onchange="updateSubToggles()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row sub-toggle" id="row-list-intent">
                <div class="toggle-info">
                    <div class="toggle-name">Require list intent</div>
                    <div class="toggle-desc">Only trigger list tools when intent is confirmed (prevents "What is an ADR?" triggering a list)</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rp-list-intent" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- LLM-mode sub-options -->
        <div class="toggle-group disabled" id="llm-options">
            <div class="toggle-group-header">LLM Mode Options</div>
            <div class="toggle-row">
                <div class="toggle-info">
                    <div class="toggle-name">Intent classifier</div>
                    <div class="toggle-desc">How queries are classified before routing</div>
                </div>
                <select class="inline-select" id="rp-intent-mode" disabled>
                    <option value="heuristic">Heuristic (fast)</option>
                    <option value="llm">LLM (accurate)</option>
                </select>
            </div>
            <div class="threshold-row" id="threshold-row">
                <div class="threshold-label">
                    <span class="threshold-name">Confidence threshold</span>
                    <span class="threshold-value" id="threshold-display">0.55</span>
                </div>
                <input type="range" id="rp-confidence" min="0" max="100" value="55" disabled
                    oninput="document.getElementById('threshold-display').textContent = (this.value / 100).toFixed(2)">
            </div>
        </div>

        <!-- Independent toggles -->
        <div class="toggle-group">
            <div class="toggle-group-header">General</div>
            <div class="toggle-row">
                <div class="toggle-info">
                    <div class="toggle-name">Elysia Tree</div>
                    <div class="toggle-desc">Multi-step reasoning via tree search. When off, uses direct retrieval + LLM.</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rp-tree" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row">
                <div class="toggle-info">
                    <div class="toggle-name">Abstain gate</div>
                    <div class="toggle-desc">Reject answers when retrieval quality is poor (prevents hallucination)</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rp-abstain" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row">
                <div class="toggle-info">
                    <div class="toggle-name">Follow-up binding</div>
                    <div class="toggle-desc">Resolve "list them" from conversation context</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rp-followup" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row">
                <div class="toggle-info">
                    <div class="toggle-name">Debug headers</div>
                    <div class="toggle-desc">Show routing info in responses (dev only)</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rp-debug">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="info-box">
            <span class="info-icon">&#9432;</span>
            <span class="info-text">
                <strong>Strict mode</strong> uses keyword matching for fast, deterministic routing.
                <strong>LLM mode</strong> classifies intent first, then routes to the Elysia Tree.
                Switching modes auto-enables the relevant sub-options and disables the irrelevant ones.
            </span>
        </div>

        <div class="btn-row">
            <button class="btn-save" id="btn-save" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <div class="toast" id="toast">Settings saved</div>

    <script>
        // ── State ──
        let policy = {};

        // ── Load on page open ──
        document.addEventListener('DOMContentLoaded', loadSettings);

        async function loadSettings() {
            try {
                const resp = await fetch('/api/settings/routing');
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                policy = data.policy || {};
                applyToUI(policy);
            } catch (err) {
                console.error('Failed to load routing settings:', err);
            }
        }

        function applyToUI(p) {
            const isStrict = p.strict_mode_enabled !== false;
            selectMode(isStrict);

            document.getElementById('rp-catalog').checked = p.catalog_short_circuit_enabled !== false;
            document.getElementById('rp-list-intent').checked = p.list_route_requires_list_intent !== false;
            document.getElementById('rp-intent-mode').value = p.intent_router_mode || 'heuristic';

            const threshold = p.intent_confidence_threshold != null ? p.intent_confidence_threshold : 0.55;
            document.getElementById('rp-confidence').value = Math.round(threshold * 100);
            document.getElementById('threshold-display').textContent = threshold.toFixed(2);

            document.getElementById('rp-tree').checked = p.tree_enabled !== false;
            document.getElementById('rp-abstain').checked = p.abstain_gate_enabled !== false;
            document.getElementById('rp-followup').checked = p.followup_binding_enabled !== false;
            document.getElementById('rp-debug').checked = !!p.debug_headers_enabled;

            updateSubToggles();
        }

        // ── Mode selection ──
        function selectMode(isStrict) {
            const strictCard = document.getElementById('mode-card-strict');
            const llmCard = document.getElementById('mode-card-llm');
            const strictOpts = document.getElementById('strict-options');
            const llmOpts = document.getElementById('llm-options');

            if (isStrict) {
                strictCard.classList.add('selected');
                llmCard.classList.remove('selected');
                strictOpts.classList.remove('disabled');
                llmOpts.classList.add('disabled');
                strictOpts.querySelectorAll('input, select').forEach(el => el.disabled = false);
                llmOpts.querySelectorAll('input, select').forEach(el => el.disabled = true);
                updateSubToggles();
            } else {
                llmCard.classList.add('selected');
                strictCard.classList.remove('selected');
                llmOpts.classList.remove('disabled');
                strictOpts.classList.add('disabled');
                llmOpts.querySelectorAll('input, select').forEach(el => el.disabled = false);
                strictOpts.querySelectorAll('input, select').forEach(el => el.disabled = true);
            }
        }

        // ── Sub-toggle dependency: catalog → list-intent ──
        function updateSubToggles() {
            const catalogOn = document.getElementById('rp-catalog').checked;
            const listRow = document.getElementById('row-list-intent');
            const listInput = document.getElementById('rp-list-intent');
            if (catalogOn) {
                listRow.classList.remove('disabled');
                listInput.disabled = false;
            } else {
                listRow.classList.add('disabled');
                listInput.disabled = true;
            }
        }

        // ── Save ──
        async function saveSettings() {
            const isStrict = document.getElementById('mode-card-strict').classList.contains('selected');

            const payload = {
                strict_mode_enabled: isStrict,
                intent_router_enabled: !isStrict,
                intent_router_mode: document.getElementById('rp-intent-mode').value,
                intent_confidence_threshold: parseInt(document.getElementById('rp-confidence').value) / 100,
                catalog_short_circuit_enabled: document.getElementById('rp-catalog').checked,
                list_route_requires_list_intent: document.getElementById('rp-list-intent').checked,
                tree_enabled: document.getElementById('rp-tree').checked,
                abstain_gate_enabled: document.getElementById('rp-abstain').checked,
                followup_binding_enabled: document.getElementById('rp-followup').checked,
                debug_headers_enabled: document.getElementById('rp-debug').checked,
            };

            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const resp = await fetch('/api/settings/routing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    policy = (await resp.json()).policy;
                    showToast('Settings saved');
                } else {
                    const err = await resp.json();
                    showToast('Error: ' + (err.detail || 'Unknown error'));
                }
            } catch (err) {
                console.error('Save failed:', err);
                showToast('Failed to save. Check server.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Settings';
            }
        }

        // ── Toast ──
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 2500);
        }
    </script>
</body>
</html>
